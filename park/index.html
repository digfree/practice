<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Cache-Control" content="public">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta name="format-detection" content="adress=no" />
    <meta http-equiv="imagetoolbar" content="no" />
    <!--<link rel="shortcut icon" href="templates/weui/assets/images/favicon/favicon.ico" type="image/x-icon" />
        <link rel="icon" type="image/png" href="templates/weui/assets/images/favicon/favicon.png" />-->
    <title>付停车费</title>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
</head>

<body>
    <div class="page-body">
        <style>
            .com_parking.with-keyboard {
                margin-bottom: 280px
            }

            .weui-loadmore {
                width: auto;
                margin: 50px 15px 0
            }

            .weui-loadmore_line .weui-loadmore__tips {
                background: #f5f5f5
            }

            pre {
                margin: 0 15px;
                color: #999;
                font-size: 14px
            }
        </style>
        <div class="weui-banner">
            <center>
                <font color="#dc143c">温馨提示: </font>当前停车场可在线支付停车费<br>
                <font color="#00bf70">请确认支付成功后再出场</font>
            </center>
        </div>
        <div class="com_parking" id="main-page">
            <div class="weui-cells__title">请点击方框输入您的车牌</div>
            <div class="weui-flex car-plate" id="plate-input">
                <div class="weui-flex__item">粤</div>
                <div class="weui-flex__item">B</div>
                <div class="weui-flex__item"></div>
                <div class="weui-flex__item"></div>
                <div class="weui-flex__item"></div>
                <div class="weui-flex__item"></div>
                <div class="weui-flex__item"></div>
                <div class="weui-flex__item"></div>
            </div>
            <div class="weui-cells__tips" id="plate-tips"></div>


            <div class="weui-btn-area">
                <button type="button" class="weui-btn weui-btn_primary" onclick="$.form.billing(this);" disabled id="process">去交费</button>
            </div>

            <div class="weui-loadmore weui-loadmore_line">
                <span class="weui-loadmore__tips">注意事项</span>
            </div>
            <pre>1. 车牌号付费仅适用于支持车牌识别的停车场;<br>2. 临牌、特殊车牌及车牌识别有误的车辆, 请到人工收费处缴费;<br>3. 临停车缴费后请在免费出场时间内离场, 超时需补缴停车费;</pre>
        </div>

        <!--BEGIN toast-->
        <div id="loadingToast" style="display:none;">
            <div class="weui-mask_transparent"></div>
            <div class="weui-toast">
                <i class="weui-loading weui-icon_toast"></i>
                <p class="weui-toast__content">数据加载中</p>
            </div>
        </div>
        <!--END toast-->

        <div id="keyboard" tabindex="0"></div>

        <script type="text/javascript" src="key.js"></script>
        <link rel="stylesheet" href="key.css">
        <script type="text/javascript">
            $(function () {
                $.form = {
                    plate: '粤B'
                };

                $.form.billing = function () {
                    // 1.1 Validate Plate Format...
                    if ($.form.plate.length != 7 && $.form.plate.length != 8) {
                        alert('您输入的车牌号码不正确');
                        return false;
                    } else {
                        $.fn.cookie('__PLATE_NUMBER__', $.form.plate, {
                            expires: 365
                        });
                    }
                    // 1.2 Query Parking Order...
                    $.ajax({
                        type: 'GET',
                        url: 'index.php?option=com_parking&task=parking.billing',
                        // data to be added to query string:
                        data: {
                            plate: $.form.plate,
                            area: '',
                        },
                        // type of data we are expecting in return:
                        dataType: 'json',
                        beforeSend: function () {
                            $($('#loadingToast').find('.weui-toast__content')[0]).html('数据加载中');
                            $('#loadingToast').fadeIn(100);
                        },
                        success: function (data) {
                            // 1.1 Check Response Payload...
                            if (data.result == undefined || data.result.length == 0) {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '抱歉, 服务繁忙<br>稍候再试');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            }
                            var payload = data.result;
                            // 1.2 Dispatch Business...
                            if (payload.monthcard == undefined) {
                                // 2.1 Temporary Parking ...
                                window.location.replace(
                                        'index.php?option=com_parking&view=bill&uuid=' +
                                        encodeURIComponent(payload.uuid) + '&plate=' +
                                        encodeURIComponent(payload.plate)) + '&area=' +
                                    encodeURIComponent('');
                                return false;
                            } else if (payload.monthcard == '1') {
                                // 2.2 Plate is VIP Go to Recharge...
                                window.location.replace(
                                        'index.php?option=com_parking&view=recharge&uuid=' +
                                        encodeURIComponent(payload.uuid) + '&plate=' +
                                        encodeURIComponent(payload.plate)) + '&area=' +
                                    encodeURIComponent('');
                                return false;
                            } else {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '您是包月/储值用户<br>请直接出场');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            }
                        },
                        error: function (xhr, type) {
                            if (xhr.status == 404) {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '未查询到停车记录<br>请核对车牌');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            } else if (xhr.status == 406) {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '您是包月/储值用户<br>请直接出场');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            } else if (xhr.status == 405) {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '车辆已开启免密支付<br>请直接出场!');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            } else if (xhr.status == 403) {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '抱歉当前平台暂不支持付费');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            } else if (xhr.status == 400) {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '车牌号码不正确');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                $('#plate-tips').html('您输入的车牌号码不正确。');
                                $('#plate-number').parent().parent().parent().addClass(
                                    'has-error');
                                return false;
                            } else if (xhr.status == 0) { // Bad Network
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '抱歉, 网络异常<br>请检查网络');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            } else {
                                $($('#loadingToast').find('.weui-toast__content')[0]).html(
                                    '抱歉, 服务繁忙<br>稍候再试');
                                setTimeout(function () {
                                    $('#loadingToast').fadeOut(100);
                                }, 3000);
                                return false;
                            }
                        },
                    });
                }

                $('#keyboard').keyboard({
                    keyset: {
                        'province': [{
                            "label": "\u4eac",
                            "val": "\u4eac"
                        }, {
                            "label": "\u6caa",
                            "val": "\u6caa"
                        }, {
                            "label": "\u7ca4",
                            "val": "\u7ca4"
                        }, {
                            "label": "\u6d25",
                            "val": "\u6d25"
                        }, {
                            "label": "\u5180",
                            "val": "\u5180"
                        }, {
                            "label": "\u664b",
                            "val": "\u664b"
                        }, {
                            "label": "\u8499",
                            "val": "\u8499"
                        }, {
                            "label": "\u8fbd",
                            "val": "\u8fbd"
                        }, {
                            "label": "\u5409",
                            "val": "\u5409"
                        }, {
                            "label": "\u9ed1",
                            "val": "\u9ed1"
                        }, {
                            "type": "newline"
                        }, {
                            "label": "\u82cf",
                            "val": "\u82cf"
                        }, {
                            "label": "\u6d59",
                            "val": "\u6d59"
                        }, {
                            "label": "\u7696",
                            "val": "\u7696"
                        }, {
                            "label": "\u95fd",
                            "val": "\u95fd"
                        }, {
                            "label": "\u8d63",
                            "val": "\u8d63"
                        }, {
                            "label": "\u9c81",
                            "val": "\u9c81"
                        }, {
                            "label": "\u8c6b",
                            "val": "\u8c6b"
                        }, {
                            "label": "\u9102",
                            "val": "\u9102"
                        }, {
                            "label": "\u6e58",
                            "val": "\u6e58"
                        }, {
                            "label": "\u6842",
                            "val": "\u6842"
                        }, {
                            "type": "newline"
                        }, {
                            "label": "\u743c",
                            "val": "\u743c"
                        }, {
                            "label": "\u6e1d",
                            "val": "\u6e1d"
                        }, {
                            "label": "\u5ddd",
                            "val": "\u5ddd"
                        }, {
                            "label": "\u8d35",
                            "val": "\u8d35"
                        }, {
                            "label": "\u4e91",
                            "val": "\u4e91"
                        }, {
                            "label": "\u85cf",
                            "val": "\u85cf"
                        }, {
                            "label": "\u9655",
                            "val": "\u9655"
                        }, {
                            "label": "\u7518",
                            "val": "\u7518"
                        }, {
                            "label": "\u9752",
                            "val": "\u9752"
                        }, {
                            "label": "\u5b81",
                            "val": "\u5b81"
                        }, {
                            "type": "newline"
                        }, {
                            "type": "switch1",
                        }, {
                            "label": "\u65b0",
                            "val": "\u65b0"
                        }, {
                            "label": "\u4f7f",
                            "val": "\u4f7f"
                        }, {
                            "type": "delete"
                        }, {
                            "label": "\u9886",
                            "val": "\u9886"
                        }, {
                            "label": "\u8b66",
                            "val": "\u8b66"
                        }, {
                            "label": "\u5b66",
                            "val": "\u5b66"
                        }, {
                            "label": "\u6e2f",
                            "val": "\u6e2f"
                        }, {
                            "label": "\u6fb3",
                            "val": "\u6fb3"
                        }, {
                            "type": "delete"
                        }],
                        'area': [{
                            "label": "1",
                            "val": "1"
                        }, {
                            "label": "2",
                            "val": "2"
                        }, {
                            "label": "3",
                            "val": "3"
                        }, {
                            "label": "4",
                            "val": "4"
                        }, {
                            "label": "5",
                            "val": "5"
                        }, {
                            "label": "6",
                            "val": "6"
                        }, {
                            "label": "7",
                            "val": "7"
                        }, {
                            "label": "8",
                            "val": "8"
                        }, {
                            "label": "9",
                            "val": "9"
                        }, {
                            "label": "0",
                            "val": "0"
                        }, {
                            'type': 'newline'
                        }, {
                            "label": "A",
                            "val": "A"
                        }, {
                            "label": "B",
                            "val": "B"
                        }, {
                            "label": "C",
                            "val": "C"
                        }, {
                            "label": "D",
                            "val": "D"
                        }, {
                            "label": "E",
                            "val": "E"
                        }, {
                            "label": "F",
                            "val": "F"
                        }, {
                            "label": "G",
                            "val": "G"
                        }, {
                            "label": "H",
                            "val": "H"
                        }, {
                            "label": "I",
                            "val": "I"
                        }, {
                            "label": "J",
                            "val": "J"
                        }, {
                            'type': 'newline'
                        }, {
                            "label": "K",
                            "val": "K"
                        }, {
                            "label": "L",
                            "val": "L"
                        }, {
                            "label": "M",
                            "val": "M"
                        }, {
                            "label": "N",
                            "val": "N"
                        }, {
                            "label": "O",
                            "val": "O"
                        }, {
                            "label": "P",
                            "val": "P"
                        }, {
                            "label": "Q",
                            "val": "Q"
                        }, {
                            "label": "R",
                            "val": "R"
                        }, {
                            "label": "S",
                            "val": "S"
                        }, {
                            'type': 'newline'
                        }, {
                            'type': 'switch2',
                        }, {
                            "label": "T",
                            "val": "T"
                        }, {
                            "label": "U",
                            "val": "U"
                        }, {
                            "label": "V",
                            "val": "V"
                        }, {
                            "label": "W",
                            "val": "W"
                        }, {
                            "label": "X",
                            "val": "X"
                        }, {
                            "label": "Y",
                            "val": "Y"
                        }, {
                            "label": "Z",
                            "val": "Z"
                        }, {
                            "type": "delete"
                        }]
                    },
                    show: function () {
                        $('#main-page').addClass('with-keyboard');
                    },
                    hide: function () {
                        $('#main-page').removeClass('with-keyboard');
                    }
                });

                $.each($('#plate-input').children(), function (i, e) {
                    $(e).click(function (e) {
                        $this = $(this);
                        $this.parent().children().removeClass('active');
                        $this.addClass('active');
                        $.Keyboard('#keyboard').switchTo((i == 0||i == 7) ? 'province' : 'area', function (keyboard, keyset) {
                            // if (i == 1) {
                            //     if ($('#plate-input').text().replace(/\s/g, '').startsWith('\u4f7f')) {
                            //         keyboard.disableKeys(keyset, ['\u6e2f', '\u6fb3', '\u5b66', '\u9886']);
                            //     } else {
                            //         keyboard.disableKeys(keyset, [1, 2, 3, 4, 5, 6, 7, 8, 9, 0, '\u6e2f', '\u6fb3', '\u5b66', '\u9886']);
                            //     }
                            // } else if (i != 6 && i != 7) {
                            //     keyboard.disableKeys(keyset, ['\u6e2f', '\u6fb3', '\u5b66', '\u9886']);
                            // } else {
                            //     keyboard.disableKeys(keyset, []);
                            // }
                        }).onKeyup(function (e) {
                            $this.html(e.label);
                            if (i == 6) {
                                $this.removeClass('active');
                                $.Keyboard('#keyboard').close();
                            } else if (i == 7) {
                                $this.addClass('unlock').removeClass('active');
                                $.Keyboard('#keyboard').close();
                            } else {
                                $this.next('.weui-flex__item').trigger('click');
                            }
                            if ($('#plate-input').text().replace(/\s/g, '').length > 6) {
                                $('#process').removeAttr('disabled');
                                $.form.plate = $('#plate-input').text().replace(/\s/g,'');
                            } else {
                                $('#process').attr('disabled', true);
                                $.form.plate = undefined;
                            }
                        }).onDelete(function () {
                            if (i == 7) $this.removeClass('unlock');

                            $this.html('');
                            $this.prev('.weui-flex__item').trigger('click')

                            if (i != 7) {
                                $('#process').attr('disabled', true);
                                $.form.plate = undefined;
                            } else if ($('#plate-input').text().replace(/\s/g, '').length >
                                6) {
                                $('#process').removeAttr('disabled');
                                $.form.plate = $('#plate-input').text().replace(/\s/g,'');
                            } else {
                                $('#process').attr('disabled', true);
                                $.form.plate = undefined;
                            }
                        });
                    })
                });
                if ($.form.plate.length != 7 && $.form.plate.length != 8) {
                    $('#process').attr('disabled', true);
                    $('#plate-input').find('>.weui-flex__item:nth-child(3)').trigger('click');
                } else {
                    $('#process').removeAttr('disabled');
                }

            });
            function switch1(){
				$(".keyboard-wrapper div").show();
				$(".keyboard-wrapper div:nth-child(1)").hide();
			}
			function switch2(){
				$(".keyboard-wrapper div").show();
				$(".keyboard-wrapper div:nth-child(2)").hide();
			}
        </script>
    </div>
    <footer class="footer fixed">
        <div style="display:none"><img src="https://c.cnzz.com/wapstat.php?siteid=1259476398&r=&rnd=2107624821" width="0" height="0" class="hide" /></div>
        <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
        <script type="text/javascript">
            $(function () {
                wx.config({
                    debug: false,
                    appId: 'wx27658dfb29da801b',
                    timestamp: 1491892499,
                    nonceStr: 'ztl923ot6fp2c2kg',
                    signature: '4c9b6b8f04b03c634c44fe43a66141f12187c45b',
                    jsApiList: ['hideAllNonBaseMenuItem', 'showAllNonBaseMenuItem', 'getLocation',
                        'scanQRCode', 'chooseWXPay', 'closeWindow', 'onMenuShareTimeline',
                        'onMenuShareAppMessage', 'openLocation'
                    ]
                });
                wx.ready(function () {
                    wx.hideAllNonBaseMenuItem();
                    if (window.onWeChatJSAPIInited != undefined)
                        window.onWeChatJSAPIInited();
                });
            });
        </script>
    </footer>
</body>

</html>